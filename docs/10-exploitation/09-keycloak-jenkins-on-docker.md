# LAB : Exploitation - Keycloak sur Docker 

**üïò : 10 minutes**

## Pr√©sentation

### Objectifs

- Interpr√©tation de code de deploiement de Keycloak
- Deploiement des services sur docker
- 


### Prerequis

- Conaissance Docker


## D√©roulement du Lab

### Etape 1: Recuperation du code

```
git clone https://github.com/wingufactory/lecloudfacile-devops-labs.git
cd lecloudfacile-devops-labs/09-exploitation/keycloak-on-docker
```

### Etape 2: Analyse du manifeste docker compose
Dans cette √©tape, Nous allons commenter l'utilit√© de chaque instruction du fichier `docker-compose.yaml` 

```yaml

# Indication de la version de l'API

version: '3.8'

# Cr√©ation d'un volume nomm√© <postgres_data> pour la persistance des donn√©es. 

volumes:
  postgres_data:

networks:
  keyjenkins:
    driver: bridge

# D√©claration liste des services

services:

  # Service keycloak_web

  keycloak_web:

    # Choix de l'image
  
    image: quay.io/keycloak/keycloak:latest

    # Nom du comteneur

    container_name: keycloak_web

    # Definition de quelque variables d'environnement
    environment:
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://keycloakdb:5432/keycloak
      KC_DB_USERNAME: keycloak
      KC_DB_PASSWORD: password

      KC_HOSTNAME: localhost
      KC_HOSTNAME_PORT: 8080
      KC_HOSTNAME_STRICT: false
      KC_HOSTNAME_STRICT_HTTPS: false

      KC_LOG_LEVEL: info
      KC_METRICS_ENABLED: true
      KC_HEALTH_ENABLED: true
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin

    # demarre keycloak en mode env dev
    command: start-dev
    
    # Pour indiquer que le service keycloak_web depend du keycloakdb pour bien demarrer correctement

    depends_on:
      - keycloakdb
    
    # Declaration du port keycloak_web et du port d'exposition externe
    ports:
      - 8080:8080

    networks:
      - keyjenkins


  # Service keycloakdb

  keycloakdb:

    # Choix de l'image
  
    image: postgres:15

    # Montage du volume pour la persitence des donn√©es

    volumes:
      - postgres_data:/var/lib/postgresql/data

    networks:
      - keyjenkins

    # Definition de quelque variables d'environnement
    environment:
      POSTGRES_DB: keycloak
      POSTGRES_USER: keycloak
      POSTGRES_PASSWORD: password

  jenkins:
    image: jenkins/jenkins:lts
    privileged: true
    user: root
    ports:
      - 8070:8080
      - 50000:50000
    container_name: jenkins
    volumes:
      - ./jenkins_configuration:/var/jenkins_home
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - keyjenkins

```



### Etape 3: Execution des services

A ce stade, toutes les configurations sont finalis√©es. Il ne reste plus qu'√† d√©marrer les services

- D√©marrage des services

La commande ci-dessous permet de d√©marrer tous les services en arri√®re-plan.

```sh
docker compose up -d
```

- Affichage des conteneurs

```sh
docker ps
```

NB: Certains containers peuvent √©chouer au d√©marrage.


### Etape 4: Test jenkins et keycloak

aller sur votre navigateur et taper le lien suivant: `localhost:8080` pour joindre le dashboard Keycloak et `localhost:8070` pour joindre le dashboard jenkins

### Etape 5: Configuration Keycloak
#### Etape 5.1 : Creation d'un realm et d'un client sur Keycloak
Creation d'un realm `ci` pour toutes les tools `CI` dont jenkins.

![](img/Screenshot%202024-09-07%20at%2020.23.27.png)

Une fois le realm cr√©√©, keycloak bascule automatiquement vers ce realm.

![](img/Screenshot%202024-09-07%20at%2020.27.35.png)

Cr√©ons maintenant notre client `jenkins`. Pour cela, aller dans `Clients` et cliquez sur `Create client`

![](img/Screenshot%202024-09-07%20at%2020.30.18.png)

Renseignez le `ClientId` et cliquez sur `NEXT` ensuite `NEXT`

![](img/Screenshot%202024-09-07%20at%2020.33.12.png)

Renseignez ensuite le `rootURL`. ici √ßa sera l'adresse de notre jenkins `http://localhost:8070/jenkins` et cliquez sur `SAVE`

![](img/Screenshot%202024-09-07%20at%2020.36.33.png)

Un r√©sum√© de la configuration s'affichera. 

![](img/Screenshot%202024-09-07%20at%2020.39.58.png)

Cliquez sur `Action` puis sur `Download adapter config`

![](img/Screenshot%202024-09-07%20at%2020.43.34.png)

Vous aurez un apercu semblable √† la capture suivante:

![](img/Screenshot%202024-09-07%20at%2020.46.09.png)

Copiez le contenu de `Details` et bien le garder dans un fichier. On en aura besoin pour l'interfacage avec jenkins.

```yaml
{
  "realm": "ci",
  "auth-server-url": "http://localhost:8080/",
  "ssl-required": "external",
  "resource": "jenkins",
  "public-client": true,
  "confidential-port": 0
}
```

Allez sur jenkins `localhost:8070`

Allez dans `Administrer jenkins` puis `plugin` et rechercher le plugin `keycloak` et installez le.

![](img/Screenshot%202024-09-07%20at%2020.51.37.png)

Une fois l'installation termin√©e, allez dans `Administrer jenkins` puis `Security`

![](img/Screenshot%202024-09-07%20at%2020.56.02.png)

Dans `Royaume pour la s√©curit√© (Realm)`, on renseignera le plugin keycloak et dans `Keycloak JSON`, on renseignera la config keycloak uis enregistrer la configuration

....
....
....
