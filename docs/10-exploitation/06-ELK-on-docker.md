# LAB : Exploitation - ELK sur Docker 

**üïò : 10 minutes**

## Pr√©sentation

### Objectifs

- Interpr√©tation de code de deploiement de ELK
- Deploiement des services sur docker
- 


### Prerequis

- Conaissance Docker
- Docker Engine (Docker Desktop mimimum 4G CPU free / 8G memoire)

## D√©roulement du Lab

### Etape 1: Recuperation du code

```
git clone https://github.com/wingufactory/lecloudfacile-devops-labs.git
cd lecloudfacile-devops-labs/09-exploitation/elk-on-docker
```

### Etape 2: Analyse du manifeste docker compose
Dans cette √©tape, Nous allons commenter l'utilit√© de chaque instruction du fichier `docker-compose.yaml` 

```yaml
# Indication de la version de l'API
version: '3.8'

# Cr√©ation d'un r√©seau nomm√© <elk> pour l'ensemble des conteneurs qui vont appartenir √† la stack.
networks:
  elk:
    driver: bridge

# Cr√©ation d'un volume nomm√© <test_data>, <ls_data> et <kb_data> pour la persistance des donn√©es. 
volumes:
  test_data:
  ls_data:
  kb_data:

# D√©claration liste des services
services:

  # Service elasticsearch

  elasticsearch:

    # Choix de l'image
  
    image: elasticsearch:7.9.1

    # Nom du comteneur

    container_name: elasticsearch

    # Declaration du port elasticsearch et du port d'exposition externe
    # Par defaut,   Elasticsearch utilise  2 ports pour ecouter le trafic TCP externe
    # Le port 9200 est utilis√© pour tous les appels d'API via HTTP. Cela inclut la recherche et les agr√©gations, la surveillance et tout ce qui utilise une requ√™te HTTP.
    # Le port 9300 est un protocole binaire personnalis√© utilis√© pour les communications entre les n≈ìuds d'un cluster. Pour des choses comme les mises √† jour de cluster, les √©lections de ma√Ætre, les n≈ìuds qui rejoignent/quittent, l'allocation de fragments

    ports:
      - "9200:9200"
      - "9300:9300"
    
    # Montage du volume pour la persitence des donn√©es

    volumes:
      - test_data:/usr/share/elasticsearch/data/
      - ./elk-config/elasticsearch/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml
    

    # Definition de quelque variables d'environnement
    environment:
      - discovery.type=single-node
      - http.host=0.0.0.0
      - transport.host=0.0.0.0
      - xpack.security.enabled=false
      - xpack.monitoring.enabled=false
      - cluster.name=elasticsearch
      - bootstrap.memory_lock=true

    # Attachement du service au r√©seau <elk> 

    networks:
      - elk


  # Service logstash

  logstash:

    # Choix de l'image
  
    
    image: logstash:7.9.1

    # Nom du comteneur

    container_name: logstash

    # Declaration du port logstash et du port d'exposition externe
    # 5044: pour les connexions entrantes du plugin Beats et pour indexer dans Elasticsearch
    # 9600: pour tous les appels d'API logstash
    ports:
      - "5044:5044"
      - "9600:9600"
    
    # Montage du volume pour la persitence des donn√©es

    volumes:
      - ./elk-config/logstash/logstash.conf:/usr/share/logstash/pipeline/logstash.conf
      - ./elk-config/logstash/logstash.yml:/usr/share/logstash/config/logstash.yml
      - ls_data:/usr/share/logstash/data

    # Attachement du service au r√©seau <elk> 

    networks:
      - elk
    
    # Pour indiquer que le service logstash depend du elasticsearch pour bien demarrer correctement
    depends_on:
      - elasticsearch

 # Service kibana

  kibana:

    # Choix de l'image
  
    image: kibana:7.9.1

    # Nom du comteneur

    container_name: kibana
    
    # Declaration du port kibana et du port d'exposition externe

    ports:
      - "5601:5601"
    
    # Montage du volume pour la persitence des donn√©es

    volumes:
      - ./elk-config/kibana/kibana.yml:/usr/share/kibana/config/kibana.yml
      - kb_data:/usr/share/kibana/data

    # Attachement du service au r√©seau <elk> 

    networks:
      - elk

    # Pour indiquer que le service logstash depend du elasticsearch pour bien demarrer correctement
    depends_on:
      - elasticsearch

```



### Etape 3: Execution des services

A ce stade, toutes les configurations sont finalis√©es. Il ne reste plus qu'√† d√©marrer les services

- D√©marrage des services

La commande ci-dessous permet de d√©marrer tous les services en arri√®re-plan.

```sh
docker compose up -d
```

- Affichage des conteneurs

```sh
docker ps
```

NB: Certains containers peuvent √©chouer au d√©marrage.


### Etape 4: Test

aller sur votre navigateur et taper le lien suivant: `localhost:5601` pour joindre le dashboard Kibana


