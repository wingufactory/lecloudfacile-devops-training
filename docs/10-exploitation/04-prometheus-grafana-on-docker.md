# LAB : Exploitation - Prometheus & Grafana sur Docker 

**üïò : 10 minutes**

## Pr√©sentation

### Objectifs

- Interpr√©tation de code de deploiement de grafana & prometheus
- Deploiement des services sur docker
- 


### Prerequis

- Conaissance Docker


## D√©roulement du Lab

### Etape 1: Recuperation du code

```
git clone https://github.com/wingufactory/lecloudfacile-devops-labs.git
cd lecloudfacile-devops-labs/09-exploitation/grafana-prometheus
```

### Etape 2: Analyse du manifeste docker compose
Dans cette √©tape, Nous allons commenter l'utilit√© de chaque instruction du fichier `docker-compose.yaml` 


```yaml
# Indication de la version de l'API
version: '3.8'

# Cr√©ation d'un r√©seau nomm√© <monitoring> pour l'ensemble des conteneurs qui vont appartenir √† la stack.
networks:
  monitoring:
    driver: bridge


# Cr√©ation d'un volume nomm√© <prometheus_data>, <grafana-storage> pour la persistance des donn√©es. 
volumes:
  prometheus_data: {}
  grafana-storage: {}

# D√©claration liste des services
services:

  # Service grafana

  grafana:

    # Choix de l'image
  
    image: grafana/grafana-enterprise

    # Nom du comteneur

    container_name: grafana

    # Toujours forcer le r√©d√©marrage du conteneur en cas de probl√®me sauf lorsqu'il est stopp√© volontairement

    restart: unless-stopped

    # Declaration du port grafana et du port d'exposition externe

    ports:
      - '3000:3000'

    # Montage du volume pour la persitence des donn√©es

    volumes:
      - grafana-storage:/var/lib/grafana
    
    # Attachement du service au r√©seau <monitoring> 

    networks:
      - monitoring

      
  # --------------------------------------------------------------------------

  
  # Service node-exporter: il  exposera les m√©triques que Prometheus pourra ensuite venir chercher.
  # Node Exporter est pour monitorer un syst√®me bas√© sur Linux.
  # Pour les syst√®mes sous Windows, vous pouvez utiliser Windows Exporter.

  node-exporter:

    # Choix de l'image

    image: prom/node-exporter:latest

    # Nom du comteneur

    container_name: node-exporter

    # Toujours forcer le r√©d√©marrage du conteneur en cas de probl√®me sauf lorsqu'il est stopp√© volontairement

    restart: unless-stopped

    # Montage du volume pour la persitence des donn√©es en read-only mode
    # Pour le service node-exporter , nous allons monter quelque repertoires (/proc, /sys, /) en mode `ro`  (read-only mode) depuis notre machine local vers le conteneur afin d'assurer le bon fonctionnement du conteneur node-exporter

    volumes:
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /:/rootfs:ro
    
    # Specifie les nouveaux repertoires du conteneur dans la configuration

    command:
      - '--path.procfs=/host/proc'
      - '--path.rootfs=/rootfs'
      - '--path.sysfs=/host/sys'
      - '--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)'

    # Declaration du port grafana et du port d'exposition externe

    ports:
      - 9100:9100

    # Attachement du service au r√©seau <monitoring> 

    networks:
      - monitoring

      
  # --------------------------------------------------------------------------

  
  # Service prometheus:

  prometheus:

    # Choix de l'image

    image: prom/prometheus:latest

    # Nom du comteneur

    container_name: prometheus

    # Toujours forcer le r√©d√©marrage du conteneur en cas de probl√®me sauf lorsqu'il est stopp√© volontairement

    restart: unless-stopped

    # Montage du volume pour la persitence des donn√©es et la configuration de prometheus

    volumes:
      - ./config/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus_data:/prometheus
    
    # Specifie la configuration de prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--web.enable-lifecycle'
    
    # Declaration du port prometheus et du port d'exposition externe

    ports:
      - '9090:9090'

    # Attachement du service au r√©seau <monitoring> 

    networks:
      - monitoring

      
  # --------------------------------------------------------------------------

  
  #  cadvisor est un utilitaire qui collecte les donn√©es d'utilisation des ressources et de performances des conteneurs en cours d'ex√©cution.
  cadvisor:

    # Choix de l'image

    image: gcr.io/cadvisor/cadvisor:v0.47.0

    # Nom du comteneur

    container_name: cadvisor

    # Specifie la configuration de cadvisor

    command:
      - '-port=8098'

    # Montage du volume pour la persitence des donn√©es en read-only mode

    volumes:
      - /:/rootfs:ro
      - /var/run:/var/run:ro
      - /sys:/sys:ro
      - /var/lib/docker/:/var/lib/docker:ro
      - /dev/disk/:/dev/disk:ro
   
   # Permet de monter `/dev/kmsg` comme un device dans le container

   devices:
      - /dev/kmsg

    # configures le service d'image √† se creer avec une certaine elevation de privileges comme root par exemple et permet au conteneur de gerer le device `/dev/kmsg`

    privileged: true

    # Toujours forcer le r√©d√©marrage du conteneur en cas de probl√®me sauf lorsqu'il est stopp√© volontairement

    restart: unless-stopped

    # Attachement du service au r√©seau <monitoring> 

    networks:
      - monitoring

  # --------------------------------------------------------------------------
      
  # Service : web_server
  web_server:

    # Choix de l'image

    image: httpd:latest

    # Declaration du port web_server et du port d'exposition externe

    ports:
      - '80:80'

    # Toujours forcer le r√©d√©marrage du conteneur en cas de probl√®me sauf lorsqu'il est stopp√© volontairement

    restart: unless-stopped

    # Attachement du service au r√©seau <monitoring> 

    networks:
      - monitoring
```


### Etape 3: Analyse du fichier de configuration prometheus 
Dans cette √©tape, nous allons configurer Prometheus pour r√©cup√©rer les m√©triques du `node-exporter` et les envoyer √† Grafana. 

Nous avons configurer les sections suivantes¬†:

`global¬†`: param√®tres de configuration par d√©faut de Prometheus global. Dans cet exemple, nous d√©finissons le scrape_interval pour r√©cup√©rer les m√©triques des t√¢ches configur√©es sur 15¬†secondes.
`scrape_configs¬†`: t√¢ches de r√©cup√©ration d√©finies.

```yaml
# Definit les param√®tres de configuration par d√©faut de Prometheus
global:

  # Pour r√©cup√©rer les m√©triques des Jobs chaque 15¬†secondes
  scrape_interval: 15s

# Definit les t√¢ches de r√©cup√©ration des metrics.
scrape_configs:

  # Job pour le node-exporter
  - job_name: 'node-exporter'

    # Permet de d√©finir comment joindre le 'node-exporter' via quel port 

    static_configs:
      - targets: ['node-exporter:9100']

  # Job pour le cadvisor

  - job_name: 'cadvisor'

    # Permet de d√©finir comment joindre le 'cadvisor' via quel port 

    static_configs:
      - targets: ['cadvisor:8098']

  # Job pour le cadvisor

  - job_name: 'apache'

    # Permet de d√©finir comment joindre le 'cadvisor' via quel port 

    static_configs:
      - targets: ['web_server:80']
```
### Etape 4: Execution des services

A ce stade, toutes les configurations sont finalis√©es. Il ne reste plus qu'√† d√©marrer les services

- D√©marrage des services

La commande ci-dessous permet de d√©marrer tous les services en arri√®re-plan.

```sh
docker compose up -d
```

- Affichage des conteneurs

```sh
docker ps
```

NB: Certains containers peuvent √©chouer au d√©marrage.


### Etape 5: Test

aller sur votre navigateur et taper le lien suivant: `localhost:3000` pour joindre le dashboard grafana et `localhost:9090` pour celui de prometheus


